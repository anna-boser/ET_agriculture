---
title: "irrigation comparison"
author: "Anna Boser"
date: '2022-05-04'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(here)
library(stringr)
library(sf)
library(tmap)
library(data.table)
library(tidyr)
library(dplyr)
library(ggplot2)
```


## ET data

```{r}
# read ET data
data <- fread(file = here("data/for_analysis/ag_counterfactual/ag_counterfactual_default0.1.csv"))
```

```{r}
# read county information and merge with ET data
counties <- fread(file=file.path(here("data", "intermediate", "counties", "counties.csv")))
counties$x <- round(counties$x, 7)
counties$y <- round(counties$y, 7)
data$x <- round(data$x, 7)
data$y <- round(data$y, 7)
data <- merge(data, counties, by = c("x", "y"))
rm(counties)
```

I need to average over monthgroups
```{r}
data <- pivot_wider(data, names_from = c(monthgroup), values_from = c(ET, ET_pred, ag_ET, PET))

data$ET <- rowMeans(select(data, ET_2, ET_3, ET_4))
data$ET_pred <- rowMeans(select(data, ET_pred_2, ET_pred_3, ET_pred_4))
data$ag_ET <- rowMeans(select(data, ag_ET_2, ag_ET_3, ag_ET_4))
data$PET <- rowMeans(select(data, PET_2, PET_3, PET_4))
```

I then need to get the total water ETd, so I average over county and then multiply by the number of days in my observation window: 183
```{r}
data <- data %>% 
  group_by(NAME) %>%
  summarize(
    ET_sd = sd(ET, na.rm=TRUE), 
    ET = mean(ET, na.rm=TRUE), 
    ET_pred_sd = sd(ET_pred, na.rm=TRUE),
    ET_pred = mean(ET_pred, na.rm=TRUE), 
    ag_ET_sd = sd(ag_ET, na.rm=TRUE), 
    ag_ET = mean(ag_ET, na.rm=TRUE), 
    PET_sd = sd(PET, na.rm=TRUE), 
    PET = mean(PET, na.rm=TRUE), 
    n = n()) #get the number of pixels in each county

data$ET_year <- data$ET*183
data$ET_pred_year <- data$ET_pred*183
data$PET_year <- data$PET*183
data$ag_ET_year <- data$ag_ET*183
```


## USGS data

### Read in USGS data. Make a single irrigation dataset with 2010 and 2015 data
```{r}
irrigation2015 <- read.csv(here("data", #this is data from 2015 (most recent)
                       "raw", 
                       "USGS_waterdata",
                       "2015",
                       "water_use"), sep = "\t")[-1,] #first row just tells you the size of the entries; remove

irrigation2010 <- read.csv(here("data", #this is data from 2010
                       "raw", 
                       "USGS_waterdata",
                       "2010",
                       "water_use"), sep = "\t")[-1,] #first row just tells you the size of the entries; remove

irrigation2015$year <- 2015
irrigation2010$year <- 2010

irrigation <- rbind(irrigation2015, irrigation2010)

rm(irrigation2010)
rm(irrigation2015)
```

### Clean USGS irrigation data
Change units to kg/day and meters squared
```{r}
irrigation$NAME <- str_remove(irrigation$county_nm, " County") # remove the "County" suffix to each county name in order to match to county shapefile names


# convert billions of gallons per day to kg per day
conversion <- function(Mgal.d){
  Mgal.d = as.numeric(Mgal.d)
  kg.d = Mgal.d * 3.785411784 * 1000000
}

to_convert = names(irrigation)[c(6:10, 15)] #the names of the columns that are in Mgal/d and need to be converted
irrigation <- mutate(irrigation, across(to_convert, conversion))


# convert thousands of acres to square meters
conversion <- function(tacre){
  tacre = as.numeric(tacre)
  m2 = tacre * 1000 * 4046.86 # conversion to acres and conversion to square meters
}

to_convert = names(irrigation)[c(11:14)] #the names of the columns that are in thousand of acres and need to be converted

irrigation <- mutate(irrigation, across(to_convert, conversion))

# add a mm/day and mm/year variable
# keep in mind the column names no longer reflect the true units
irrigation$mm.day <- irrigation$Irrigation..Crop.total.self.supplied.withdrawals.for.crops..fresh..in.Mgal.d/irrigation$Irrigation..Crop.total.irrigation.for.crops..in.thousand.acres

irrigation$mm.year <- irrigation$mm.day*365
```

### Read in county shapefile
```{r}
counties <- st_read(here("data", "raw", "shapefiles", "study_area_counties", "study_area_counties.shp"))
```

### Merge dataframes 
```{r}
counties_irrigation <- base::merge(counties, irrigation, by = "NAME")
```


### Plot irrigation data -- mm over agricultural lands for 2010 and 2015
```{r}
# 2010
filter(counties_irrigation, year == 2010) %>% 
  tm_shape() +
  tm_polygons("mm.year")

# 2015
filter(counties_irrigation, year == 2015) %>% 
  tm_shape() +
  tm_polygons("mm.year")
```

## Both datasets

```{r}
CV <- st_read(here("data", "raw", "shapefiles", "cimis_CV", "cimis_CV.shp"))
```


```{r}
data <- base::merge(counties_irrigation, data, by="NAME")
data$irrigation_efficiency <- data$ag_ET_year*100/data$mm.year
```


```{r}
filter(data, year == 2010) %>% 
  tm_shape() +
  tm_polygons("irrigation_efficiency") + 
  tm_shape(CV) + 
  tm_borders()

filter(data, year == 2015) %>% 
  tm_shape() +
  tm_polygons("irrigation_efficiency") + 
  tm_shape(CV) + 
  tm_borders()
```



```{r}
data %>% 
  tm_shape() +
  tm_polygons("ag_ET") + 
  tm_shape(CV) + 
  tm_borders()

data %>% 
  tm_shape() +
  tm_polygons("ag_ET_sd") + 
  tm_shape(CV) + 
  tm_borders()

data %>% 
  tm_shape() +
  tm_polygons("n") + 
  tm_shape(CV) + 
  tm_borders()
```

```{r}
filter(data, year == 2010) %>% 
  tm_shape() +
  tm_polygons("mm.year") + 
  tm_shape(CV) + 
  tm_borders()

filter(data, year == 2015) %>% 
  tm_shape() +
  tm_polygons("mm.year") + 
  tm_shape(CV) + 
  tm_borders()
```


```{r}
data$percent_total_ET <- data$ET_year*100/data$mm.year

filter(data, year == 2010) %>% 
  tm_shape() +
  tm_polygons("percent_total_ET") + 
  tm_shape(CV) + 
  tm_borders()

filter(data, year == 2015) %>% 
  tm_shape() +
  tm_polygons("percent_total_ET") + 
  tm_shape(CV) + 
  tm_borders()
```

```{r}
data %>% 
  tm_shape() +
  tm_polygons("ET_year")
```


Irrigation efficiency and irrigation technology
Let's do some analysis of types of irrigation versus efficiency when controlling for PET
```{r}
data <- data %>% 
  mutate(
    sprinkler = Irrigation..Crop.sprinkler.irrigation.for.crops..in.thousand.acres/Irrigation..Crop.total.irrigation.for.crops..in.thousand.acres, 
    microirrigation = Irrigation..Crop.microirrigation.for.crops..in.thousand.acres/Irrigation..Crop.total.irrigation.for.crops..in.thousand.acres, 
    surface = Irrigation..Crop.surface.irrigation.for.crops..in.thousand.acres/Irrigation..Crop.total.irrigation.for.crops..in.thousand.acres)

# data2015 %>% pivot_longer(cols = c(sprinkler, microirrigation, surface), names_to="irrigation_type", values_to = "percent")
```


```{r}
lm <- lm(irrigation_efficiency~sprinkler+microirrigation+surface -1, data)
summary(lm)
```


microirrigation and PET are inversely correlated, meaning micro is probably being undervalued, while surface is positively correlated, meaning it's likely overvalued. 
```{r}
lm <- lm(irrigation_efficiency~sprinkler+microirrigation+surface+PET -1, data)
summary(lm)
```


```{r}
data %>% 
  pivot_longer(cols = c(sprinkler, microirrigation, surface), names_to="irrigation_type", values_to = "percent") %>%
  ggplot(aes(x=percent, y=irrigation_efficiency)) + 
  geom_point(aes(color=NAME)) + 
  geom_smooth(method="lm") +
  facet_grid(cols = vars(irrigation_type))
```

```{r}
data %>% 
  ggplot(aes(x=PET, y=irrigation_efficiency)) + 
  geom_point() + 
  geom_smooth(method="lm")
```
^statistically significant


